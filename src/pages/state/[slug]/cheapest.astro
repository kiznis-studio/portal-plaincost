---
export const prerender = false;
import Base from '../../../layouts/Base.astro';
import { getStateBySlug, getLeastExpensiveMsasByState, formatRpp } from '../../../lib/db';

const { slug } = Astro.params;
if (!slug) return Astro.redirect('/404');

const db = Astro.locals.runtime.env.DB;
const state = await getStateBySlug(db, slug);
if (!state) return Astro.redirect('/404');

const metros = await getLeastExpensiveMsasByState(db, state.abbr, 25);
if (metros.length === 0) return Astro.redirect(`/state/${slug}`);
---

<Base
  title={`Cheapest Cities in ${state.name} 2026 — Cost of Living Rankings`}
  description={`Most affordable metro areas in ${state.name} ranked by BEA Regional Price Parity index. Find the cheapest places to live in ${state.name}.`}
  breadcrumbs={[{ name: 'Home', href: '/' }, { name: 'States', href: '/states' }, { name: state.name, href: `/state/${slug}` }, { name: 'Cheapest' }]}
>
  <section class="max-w-4xl mx-auto px-4 py-8">
    <div class="mb-2 text-sm text-[var(--color-text-secondary)]">
      <a href="/" class="hover:text-[var(--color-primary)]">Home</a> /
      <a href="/states" class="hover:text-[var(--color-primary)]">States</a> /
      <a href={`/state/${slug}`} class="hover:text-[var(--color-primary)]">{state.name}</a> /
    </div>
    <h1 class="text-2xl md:text-3xl font-bold mb-2">Cheapest Cities in {state.name}</h1>
    <p class="text-[var(--color-text-secondary)] mb-6">{metros.length} most affordable metro areas ranked by cost of living index</p>

    <div class="flex flex-wrap gap-2 mb-6">
      <a href={`/state/${slug}/most-expensive`} class="px-4 py-2 rounded-lg text-sm font-medium bg-[var(--color-surface)] border border-[var(--color-border)] text-[var(--color-text)] hover:border-[var(--color-primary)] transition-colors">Most Expensive</a>
      <span class="px-4 py-2 rounded-lg text-sm font-medium bg-[var(--color-primary)] text-white">Cheapest</span>
      <a href={`/state/${slug}`} class="px-4 py-2 rounded-lg text-sm font-medium bg-[var(--color-surface)] border border-[var(--color-border)] text-[var(--color-text)] hover:border-[var(--color-primary)] transition-colors">← Back to {state.name}</a>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b border-[var(--color-border)] text-left text-[var(--color-text-secondary)]">
            <th class="pb-2 font-medium w-8">#</th>
            <th class="pb-2 font-medium">Metro</th>
            <th class="pb-2 font-medium text-right">Overall</th>
            <th class="pb-2 font-medium text-right hidden sm:table-cell">Goods</th>
            <th class="pb-2 font-medium text-right hidden sm:table-cell">Services</th>
            <th class="pb-2 font-medium text-right hidden md:table-cell">Rents</th>
          </tr>
        </thead>
        <tbody>
          {metros.map((msa, i) => (
            <tr class="border-b border-[var(--color-border)] hover:bg-[var(--color-surface)] transition-colors">
              <td class="py-3 text-[var(--color-text-secondary)]">{i + 1}</td>
              <td class="py-3">
                <a href={`/metro/${msa.slug}`} class="text-[var(--color-primary)] hover:underline font-medium">{msa.name}</a>
              </td>
              <td class="py-3 text-right font-medium">{formatRpp(msa.rpp_all)}</td>
              <td class="py-3 text-right hidden sm:table-cell">{formatRpp(msa.rpp_goods)}</td>
              <td class="py-3 text-right hidden sm:table-cell">{formatRpp(msa.rpp_services)}</td>
              <td class="py-3 text-right hidden md:table-cell">{formatRpp(msa.rpp_rents)}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>

    <!-- National rankings link -->
    <div class="mt-6 flex flex-wrap gap-3">
      <a href="/rankings/most-expensive" class="text-sm text-[var(--color-primary)] hover:underline">National: Most Expensive →</a>
      <a href="/rankings/cheapest" class="text-sm text-[var(--color-primary)] hover:underline">National: Cheapest →</a>
      <a href="/rankings/highest-rents" class="text-sm text-[var(--color-primary)] hover:underline">National: Highest Rents →</a>
    </div>

    <p class="text-xs text-[var(--color-text-secondary)] mt-6">
      Source: Bureau of Economic Analysis, Regional Price Parities. Index where national average = 100.
    </p>
  </section>
</Base>
